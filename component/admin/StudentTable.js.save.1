"use client";
import { useState, useMemo } from 'react';
import DataTable from 'react-data-table-component';
import Select from 'react-select';

const StudentTable = ({
  registrations = [],
  users = [],
  loading,
  onRefresh,
}) => {
  const [filterText, setFilterText] = useState('');
  const [deletingId, setDeletingId] = useState(null);
  const [editingRegistration, setEditingRegistration] = useState(null);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showNotesModal, setShowNotesModal] = useState(false);
  const [showHistoryModal, setShowHistoryModal] = useState(false);
  const [selectedRegistration, setSelectedRegistration] = useState(null);
  const [followupNotes, setFollowupNotes] = useState([]);
  const [newNote, setNewNote] = useState("");
  const [loadingNotes, setLoadingNotes] = useState(false);
  const [addingNote, setAddingNote] = useState(false);
  const [updatingRegistration, setUpdatingRegistration] = useState(false);

  // Edit modal state variables
  const [editSelectedCategories, setEditSelectedCategories] = useState([]);
  const [editSelectedSubjects, setEditSelectedSubjects] = useState([]);
  const [editSelectedCourses, setEditSelectedCourses] = useState([]);
  const [editAvailableSubjects, setEditAvailableSubjects] = useState([]);
  const [editAvailableCourses, setEditAvailableCourses] = useState([]);
  const [subjectDetails, setSubjectDetails] = useState([]);

  // Categories
  const categories = [
    { value: "Grade-1", label: "Grade 1" },
    { value: "Grade-2", label: "Grade 2" },
    { value: "Grade-3", label: "Grade 3" },
    { value: "Grade-4", label: "Grade 4" },
    { value: "Grade-5", label: "Grade 5" },
    { value: "Grade-6", label: "Grade 6" },
    { value: "Grade-7", label: "Grade 7" },
    { value: "Grade-8", label: "Grade 8" },
    { value: "Grade-9", label: "Grade 9 (Freshman Year)" },
    { value: "Grade-10", label: "Grade 10 (Sophomore Year)" },
    { value: "Grade-11", label: "Grade 11 (Junior Year)" },
    { value: "Grade-12", label: "Grade 12 (Senior Year)" },
    { value: "AP-Courses", label: "AP Courses" },
    { value: "College-Tests", label: "College Tests" },
  ];

  const gradeSubjects = [
    "English Language Arts",
    "Mathematics",
    "Science",
    "Social Studies",
    "Arts Education",
    "Physical Education/Health",
  ];

  const apSubjectCategories = [
    "English Language Arts",
    "Mathematics",
    "Science",
    "GENERAL SUBJECTS",
    "COMPUTER SCIENCE",
  ];

  const collegeTests = [
    "SAT (Math + English)",
    "SAT Math",
    "SAT English",
    "PSAT",
    "ACT",
  ];

  // Helper function to parse JSON data
  const parseJsonData = (jsonString) => {
    if (!jsonString) return [];
    try {
      return JSON.parse(jsonString);
    } catch {
      return typeof jsonString === "string"
        ? jsonString
            .split(",")
            .map((s) => s.trim())
            .filter((s) => s)
        : [jsonString];
    }
  };

  const handleEditCategoryChange = (selectedOptions) => {
    const categoryValues = selectedOptions
      ? selectedOptions.map((option) => option.value)
      : [];
    setEditSelectedCategories(categoryValues);

    let subjects = [];
    const hasGrades = categoryValues.some((cat) => cat.startsWith("Grade-"));
    const hasAPCourses = categoryValues.includes("AP-Courses");
    const hasCollegeTests = categoryValues.includes("College-Tests");

    if (hasGrades) {
      subjects = [...subjects, ...gradeSubjects];
    }
    if (hasAPCourses) {
      subjects = [...subjects, ...apSubjectCategories];
    }
    if (hasCollegeTests) {
      subjects = [...subjects, ...collegeTests];
    }

    const uniqueSubjects = [...new Set(subjects)];
    setEditAvailableSubjects(uniqueSubjects);

    setEditSelectedSubjects((prevSubjects) =>
      prevSubjects.filter((subject) => uniqueSubjects.includes(subject))
    );

    if (!hasAPCourses) {
      setEditSelectedCourses([]);
      setEditAvailableCourses([]);
    }
  };

const newSubjectDetails = subjectValues.map(subject => {
    // Check if this subject already has details
    const existing = subjectDetails.find(sd => sd.subject === subject);
    return existing || {
      subject: subject,
      session_start_date: '',
      number_of_sessions: '',
      class_type: ''
    };
  });
  setSubjectDetails(newSubjectDetails);

  const hasAPCourses = editSelectedCategories.includes("AP-Courses");

  if (hasAPCourses && subjectValues.length > 0) {
    await fetchEditAPCourses(subjectValues);
  } else {
    setEditAvailableCourses([]);
    setEditSelectedCourses([]);
  }
};

  const fetchEditAPCourses = async (apSubjectCategories) => {
    try {
      let allCourses = [];

      for (const subjectCategory of apSubjectCategories) {
        const response = await fetch(
          `/api/auth/courses/?parent_category=${encodeURIComponent(
            "AP Courses"
          )}&subject_category=${encodeURIComponent(subjectCategory)}`
        );

        if (response.ok) {
          const data = await response.json();
          allCourses = [...allCourses, ...data.courses];
        }
      }

      const uniqueCourses = allCourses.filter(
        (course, index, self) =>
          index === self.findIndex((c) => c.id === course.id)
      );

      setEditAvailableCourses(uniqueCourses);

      setEditSelectedCourses((prevSelected) =>
        prevSelected.filter((courseId) =>
          uniqueCourses.some((course) => course.id === courseId)
        )
      );
    } catch (error) {
      console.error("Error fetching AP courses:", error);
    }
  };


const handleEditRegistration = async (registrationId) => {
  try {
    const response = await fetch(`/api/auth/students/${registrationId}/`);
    if (response.ok) {
      const data = await response.json();
      const reg = data.student;
      
      setEditingRegistration(reg);
      
      const categories = parseJsonData(reg.selected_categories);
      const subjects = parseJsonData(reg.selected_subjects);
      const courses = parseJsonData(reg.selected_courses);
      
      // Parse subject details if they exist
      let parsedSubjectDetails = [];
      if (reg.subject_details) {
        try {
          parsedSubjectDetails = JSON.parse(reg.subject_details);
        } catch (e) {
          console.error('Error parsing subject_details:', e);
        }
      }
      
      // Initialize subject details for all subjects
      const initialSubjectDetails = subjects.map(subject => {
        const existing = parsedSubjectDetails.find(sd => sd.subject === subject);
        return existing || {
          subject: subject,
          session_start_date: '',
          number_of_sessions: '',
          class_type: ''
        };
      });
      
      setSubjectDetails(initialSubjectDetails);
      setEditSelectedCategories(categories);
      setEditSelectedSubjects(subjects);
      setEditSelectedCourses(courses);
      
      let availSubjects = [];
      const hasGrades = categories.some(cat => cat.startsWith('Grade-'));
      const hasAPCourses = categories.includes('AP-Courses');
      const hasCollegeTests = categories.includes('College-Tests');
      
      if (hasGrades) availSubjects = [...availSubjects, ...gradeSubjects];
      if (hasAPCourses) availSubjects = [...availSubjects, ...apSubjectCategories];
      if (hasCollegeTests) availSubjects = [...availSubjects, ...collegeTests];
      
      setEditAvailableSubjects([...new Set(availSubjects)]);
      
      if (hasAPCourses && subjects.length > 0) {
        await fetchEditAPCourses(subjects);
      }
      
      setShowEditModal(true);
    }
  } catch (error) {
    console.error("Error fetching registration:", error);
  }
};

 const handleUpdateRegistration = async (e) => {
  e.preventDefault();
  setUpdatingRegistration(true);

  try {
    const response = await fetch(
      `/api/auth/students/${editingRegistration.id}/`,
      {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ...editingRegistration,
          selectedCategories: editSelectedCategories,
          selectedSubjects: editSelectedSubjects,
          selectedCourses: editSelectedCourses,
          subjectDetails: subjectDetails // Add this line
        }),
      }
    );

    if (response.ok) {
      onRefresh();
      setShowEditModal(false);
      setEditingRegistration(null);
      setEditSelectedCategories([]);
      setEditSelectedSubjects([]);
      setEditSelectedCourses([]);
      setEditAvailableSubjects([]);
      setEditAvailableCourses([]);
      setSubjectDetails([]); // Add this line
      alert("Registration updated successfully!");
    } else {
      const data = await response.json();
      alert(data.error || "Failed to update registration");
    }
  } catch (error) {
    alert("Error updating registration");
    console.error("Update registration error:", error);
  } finally {
    setUpdatingRegistration(false);
  }
};

const handleSubjectDetailChange = (index, field, value) => {
  const updatedDetails = [...subjectDetails];
  updatedDetails[index] = {
    ...updatedDetails[index],
    [field]: value
  };
  setSubjectDetails(updatedDetails);
};

  const handleDeleteRegistration = async (registrationId, studentName) => {
    if (
      !window.confirm(
        `Are you sure you want to disable student for "${studentName}"? This action cannot be undone.`
      )
    ) {
      return;
    }

    setDeletingId(registrationId);
    try {
      const response = await fetch(
        `/api/auth/students/${registrationId}/`,
        {
          method: "DELETE",
        }
      );

      if (response.ok) {
        onRefresh();
      } else {
        alert("Failed to delete student");
      }
    } catch (error) {
      alert("Error deleting student");
      console.error("Delete stduent error:", error);
    } finally {
      setDeletingId(null);
    }
  };

  const openNotesModal = (registration) => {
    setSelectedRegistration(registration);
    setShowNotesModal(true);
  };


const handleGenerateInvoice = async (studentId) => {
  try {
    const response = await fetch('/api/auth/invoices/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ studentId })
    });

    if (response.ok) {
      const data = await response.json();
      alert(`Invoice ${data.invoice.invoice_number} generated successfully!`);
      
      // Open PDF in new tab
      window.open(data.invoice.pdf_path, '_blank');
      
      onRefresh();
    } else {
      const error = await response.json();
      alert(error.error || 'Failed to generate invoice');
    }
  } catch (error) {
    console.error('Generate invoice error:', error);
    alert('Error generating invoice');
  }
};



 const columns = useMemo(() => [
    {
      name: 'ID',
      selector: (row, index) => index + 1,
      sortable: true,
      width: '60px',
    },
    {
      name: 'Parent Name',
      selector: row => row.parent_name || 'N/A',
      sortable: true,
      width: '150px',
    },
    {
      name: 'Student Name',
      selector: row => row.student_name || 'N/A',
      sortable: true,
      width: '150px',
    },
    {
      name: 'Grade',
      selector: row => row.student_grade || 'N/A',
      sortable: true,
      width: '80px',
    },
    {
      name: 'Phone',
      selector: row => row.phone || 'N/A',
      sortable: true,
      width: '130px',
    },
    {
      name: 'Email',
      selector: row => row.email || 'N/A',
      sortable: true,
      width: '180px',
    },
    {
      name: 'Assigned To',
      selector: row => row.assignee_name || 'Unassigned',
      sortable: true,
      width: '130px',
    },
{
name: 'Categories',
    cell: row => (
      row.selected_categories && Array.isArray(row.selected_categories) ? (
        <div>
          {row.selected_categories.map((category, index) => (
            <span key={index} className="badge bg-info me-1 mb-1" style={{fontSize: '10px'}}>
              {category}
            </span>
          ))}
        </div>
      ) : <span className="text-muted">-</span>
    ),
    width: '200px',

},
  {
    name: 'Subjects',
    cell: row => (
      row.selected_subjects && Array.isArray(row.selected_subjects) ? (
        <div>
          {row.selected_subjects.map((subject, index) => (
            <span key={index} className="badge bg-info me-1 mb-1" style={{fontSize: '10px'}}>
              {subject}
            </span>
          ))}
        </div>
      ) : <span className="text-muted">-</span>
    ),
    width: '200px',
  },

{
  name: 'Courses',
  cell: row => (
    row.course_details && row.course_details.length > 0 ? (
      <div>
        {row.course_details.map((course) => (
          <span key={course.id} className="badge bg-primary me-1 mb-1" style={{fontSize: '10px'}}>
            {course.name}
          </span>
        ))}
      </div>
    ) : <span className="text-muted">No courses</span>
  ),
  width: '250px',
},
    {
      name: 'Session Start',
      selector: row => row.session_start_date,
      sortable: true,
      format: row => row.session_start_date ? new Date(row.session_start_date).toLocaleDateString() : 'Not Set',
      width: '120px',
    },
    {
      name: 'Sessions',
      selector: row => row.number_of_sessions || 'N/A',
      sortable: true,
      width: '90px',
    },
    {
      name: 'Class Type',
      selector: row => row.class_type || 'N/A',
      sortable: true,
      width: '120px',
    },
    {
      name: 'Actions',
      cell: row => (
        <div className="action-buttons">
          <button
            className="btn btn-sm btn-outline-primary tooltip-btn"
            title="Edit Student Info"
            onClick={() => handleEditRegistration(row.id)}
          >
            <i className="fas fa-edit"></i>
          </button>
          <button
            className={`btn btn-sm tooltip-btn ${
              row.session_start_date && row.number_of_sessions
                ? "btn-outline-success"
                : "btn-outline-secondary"
            }`}
            title={
              row.session_start_date && row.number_of_sessions
                ? "Generate/View Invoice"
                : "Complete session details to generate invoice"
            }
            onClick={() =>
              row.session_start_date && row.number_of_sessions
                ? handleGenerateInvoice(row.id)
                : null
            }
            disabled={!row.session_start_date || !row.number_of_sessions}
          >
            <i className="fas fa-file-invoice-dollar"></i>
          </button>
          <button
            className="btn btn-sm btn-outline-danger tooltip-btn"
            title="Disable Student"
            onClick={() => handleDeleteRegistration(row.id, row.student_name)}
            disabled={deletingId === row.id}
          >
            {deletingId === row.id ? (
              <i className="fas fa-spinner fa-spin"></i>
            ) : (
              <i className="fas fa-times"></i>
            )}
          </button>
        </div>
      ),
      ignoreRowClick: true,
      button: true,
      width: '200px',
    },
  ], [deletingId]);

  // Filter data
  const filteredItems = registrations.filter(item => {
    const searchStr = filterText.toLowerCase();
    return (
      item.parent_name?.toLowerCase().includes(searchStr) ||
      item.student_name?.toLowerCase().includes(searchStr) ||
      item.phone?.toLowerCase().includes(searchStr) ||
      item.email?.toLowerCase().includes(searchStr)
    );
  });

  // Search component
  const subHeaderComponent = useMemo(() => {
    return (
      <input
        type="text"
        placeholder="Search students..."
        className="form-control"
        style={{ width: '300px' }}
        value={filterText}
        onChange={e => setFilterText(e.target.value)}
      />
    );
  }, [filterText]);

  return (
    <>
      <div className="data-table">
      <DataTable
          columns={columns}
          data={filteredItems}
          pagination
          paginationPerPage={25}
          paginationRowsPerPageOptions={[10, 25, 50, 100]}
          progressPending={loading}
          highlightOnHover
          pointerOnHover
          striped
          subHeader
          subHeaderComponent={subHeaderComponent}
          noDataComponent="No students found"
          defaultSortFieldId={1}
          /> 


      </div>

      {showEditModal && editingRegistration && (
        <div className="modal-overlay">
          <div className="modal-content large-modal">
            <div className="modal-header">
              <h5>Edit Registration</h5>
              <button onClick={() => setShowEditModal(false)}>×</button>
            </div>
            <form onSubmit={handleUpdateRegistration}>
              <div className="modal-body">
                <div className="row">
                  <div className="col-md-6">
                    <div className="form-group">
                      <label>Parent Name *</label>
                      <input
                        type="text"
                        className="form-control"
                        value={editingRegistration.parent_name || ""}
                        onChange={(e) =>
                          setEditingRegistration({
                            ...editingRegistration,
                            parent_name: e.target.value,
                          })
                        }
                        required
                      />
                    </div>
                  </div>
                  <div className="col-md-6">
                    <div className="form-group">
                      <label>Student Name *</label>
                      <input
                        type="text"
                        className="form-control"
                        value={editingRegistration.student_name || ""}
                        onChange={(e) =>
                          setEditingRegistration({
                            ...editingRegistration,
                            student_name: e.target.value,
                          })
                        }
                        required
                      />
                    </div>
                  </div>
                  <div className="col-md-6">
                    <div className="form-group">
                      <label>Lives In</label>
                      <input
                        type="text"
                        className="form-control"
                        value={editingRegistration.lives_in || ""}
                        onChange={(e) =>
                          setEditingRegistration({
                            ...editingRegistration,
                            lives_in: e.target.value,
                          })
                        }
                      />
                    </div>
                  </div>
                  <div className="col-md-6">
                    <div className="form-group">
                      <label>Contacted Via</label>
                      <select
                        className="form-control"
                        value={editingRegistration.contacted_via || ""}
                        onChange={(e) =>
                          setEditingRegistration({
                            ...editingRegistration,
                            contacted_via: e.target.value,
                          })
                        }
                      >
                        <option value="">Select Method</option>
                        <option value="Phone">Phone</option>
                        <option value="Email">Email</option>
                        <option value="WhatsApp">WhatsApp</option>
                        <option value="In Person">In Person</option>
                      </select>
                    </div>
                  </div>
                  <div className="col-md-6">
                    <div className="form-group">
                      <label>Student Grade</label>
                      <input
                        type="text"
                        className="form-control"
                        value={editingRegistration.student_grade || ""}
                        onChange={(e) =>
                          setEditingRegistration({
                            ...editingRegistration,
                            student_grade: e.target.value,
                          })
                        }
                      />
                    </div>
                  </div>
                  <div className="col-md-6">
                    <div className="form-group">
                      <label>School Name</label>
                      <input
                        type="text"
                        className="form-control"
                        value={editingRegistration.school_name || ""}
                        onChange={(e) =>
                          setEditingRegistration({
                            ...editingRegistration,
                            school_name: e.target.value,
                          })
                        }
                      />
                    </div>
                  </div>
                  <div className="col-md-6">
                    <div className="form-group">
                      <label>Phone</label>
                      <input
                        type="tel"
                        className="form-control"
                        value={editingRegistration.phone || ""}
                        onChange={(e) =>
                          setEditingRegistration({
                            ...editingRegistration,
                            phone: e.target.value,
                          })
                        }
                      />
                    </div>
                  </div>
                  <div className="col-md-6">
                    <div className="form-group">
                      <label>Email</label>
                      <input
                        type="email"
                        className="form-control"
                        value={editingRegistration.email || ""}
                        onChange={(e) =>
                          setEditingRegistration({
                            ...editingRegistration,
                            email: e.target.value,
                          })
                        }
                      />
                    </div>
                  </div>
                  <div className="col-md-6">
                    <div className="form-group">
                      <label>Assign To</label>
                      <select
                        className="form-control"
                        value={editingRegistration.assignee_id || ""}
                        onChange={(e) =>
                          setEditingRegistration({
                            ...editingRegistration,
                            assignee_id: e.target.value,
                          })
                        }
                      >
                        <option value="">Select User</option>
                        {users && users.length > 0 ? (
                          users.map((user) => (
                            <option key={user.id} value={user.id}>
                              {user.name}
                            </option>
                          ))
                        ) : (
                          <option value="">Loading users...</option>
                        )}
                      </select>
                    </div>
                  </div>
                  
            <div className="col-md-6">
                    <div className="form-group">
                      <label>Referred By</label>
                      <input
                        type="text"
                        className="form-control"
                        value={editingRegistration.referred_by || ""}
                        onChange={(e) =>
                          setEditingRegistration({
                            ...editingRegistration,
                            referred_by: e.target.value,
                          })
                        }
                      />
                    </div>
                  </div>


<div className="col-md-6">
  <div className="form-group">
    <label>Session Start Date & Time</label>
    <input
      type="date"
      className="form-control"
      value={
        editingRegistration.session_start_date
          ? new Date(editingRegistration.session_start_date)
              .toISOString()
              .slice(0, 10)
          : ""
      }
      onChange={(e) =>
        setEditingRegistration({
          ...editingRegistration,
          session_start_date: e.target.value,
        })
      }
    />
  </div>
</div>

<div className="col-md-6">
  <div className="form-group">
    <label>Number of Sessions</label>
    <select
      className="form-control"
      value={editingRegistration.number_of_sessions || ""}
      onChange={(e) =>
        setEditingRegistration({
          ...editingRegistration,
          number_of_sessions: e.target.value,
        })
      }
    >
      <option value="">Select Sessions</option>
      <option value="10">10 Sessions</option>
      <option value="35">35 Sessions</option>
      <option value="70">70 Sessions</option>
    </select>
  </div>
</div>

{/* Class Type */}
<div className="col-md-6">
  <div className="form-group">
    <label>Class Type</label>
    <select
      className="form-control"
      value={editingRegistration.class_type || ""}
      onChange={(e) =>
        setEditingRegistration({
          ...editingRegistration,
          class_type: e.target.value,
        })
      }
    >
      <option value="">Select Type</option>
      <option value="1 on 1">1 on 1</option>
      <option value="Group 2 to 4">Group 2 to 4</option>
    </select>
  </div>
</div>



                  <div className="col-12">
                    <div className="form-group">
                      <label>Notes</label>
                      <textarea
                        className="form-control"
                        rows="3"
                        value={editingRegistration.notes || ""}
                        onChange={(e) =>
                          setEditingRegistration({
                            ...editingRegistration,
                            notes: e.target.value,
                          })
                        }
                      ></textarea>
                    </div>
                  </div>

                  {/* Categories Selection */}
                  <div className="col-12">
                    <div className="form-group">
                      <label>
                        <strong>Step 1: Select Categories *</strong>
                        <br />
                        <small className="text-muted">
                          Choose Grades, AP Courses, or College Tests
                        </small>
                      </label>
                      <Select
                        isMulti
                        value={editSelectedCategories.map((cat) => ({
                          value: cat,
                          label:
                            categories.find((c) => c.value === cat)?.label ||
                            cat,
                        }))}
                        options={categories}
                        onChange={handleEditCategoryChange}
                        placeholder="Select categories..."
                        className="react-select-container"
                        classNamePrefix="react-select"
                      />
                    </div>
                  </div>

                  {/* Subjects Selection */}
                  {editAvailableSubjects.length > 0 && (
                    <div className="col-12">
                      <div className="form-group">
                        <label>
                          <strong>Step 2: Select Subjects *</strong>
                          <br />
                          <small className="text-muted">
                            {editSelectedCategories.includes("AP-Courses")
                              ? "For AP Courses: Select subject categories, then choose specific courses in Step 3"
                              : "For Grades/College Tests: These are your final selections"}
                          </small>
                        </label>
                        <Select
                          isMulti
                          value={editSelectedSubjects.map((subject) => ({
                            value: subject,
                            label: subject,
                          }))}
                          options={editAvailableSubjects.map((subject) => ({
                            value: subject,
                            label: subject,
                          }))}
                          onChange={handleEditSubjectChange}
                          placeholder="Select subjects..."
                          className="react-select-container"
                          classNamePrefix="react-select"
                        />
                      </div>
                    </div>
                  )}

                  {/* Courses Selection (AP only) */}
                  {editSelectedCategories.includes("AP-Courses") &&
                    editSelectedSubjects.length > 0 &&
                    editAvailableCourses.length > 0 && (
                      <div className="col-12">
                        <div className="form-group">
                          <label>
                            <strong>
                              Step 3: Select Specific AP Courses *
                            </strong>
                            <br />
                            <small className="text-muted">
                              Choose the exact AP courses the student needs
                            </small>
                          </label>
                          <Select
                            isMulti
                            value={editSelectedCourses
                              .map((courseId) => {
                                const course = editAvailableCourses.find(
                                  (c) => c.id === courseId
                                );
                                return course
                                  ? {
                                      value: course.id,
                                      label: course.course_name,
                                    }
                                  : null;
                              })
                              .filter(Boolean)}
                            options={editAvailableCourses.map((course) => ({
                              value: course.id,
                              label: course.course_name,
                            }))}
                            onChange={(selectedOptions) => {
                              setEditSelectedCourses(
                                selectedOptions
                                  ? selectedOptions.map((opt) => opt.value)
                                  : []
                              );
                            }}
                            placeholder="Select specific AP courses..."
                            className="react-select-container"
                            classNamePrefix="react-select"
                          />
                        </div>
                      </div>
                    )}

                  {/* Selection Summary */}
                  {(editSelectedCategories.length > 0 ||
                    editSelectedSubjects.length > 0 ||
                    editSelectedCourses.length > 0) && (
                    <div className="col-12">
                      <div className="form-group">
                        <label>
                          <strong>Selection Summary:</strong>
                        </label>
                        <div className="alert alert-info">
                          <div>
                            <strong>Categories:</strong>{" "}
                            {editSelectedCategories.join(", ") || "None"}
                          </div>
                          <div>
                            <strong>Subjects:</strong>{" "}
                            {editSelectedSubjects.join(", ") || "None"}
                          </div>
                          {editSelectedCourses.length > 0 && (
                            <div>
                              <strong>AP Courses:</strong>{" "}
                              {editAvailableCourses
                                .filter((c) =>
                                  editSelectedCourses.includes(c.id)
                                )
                                .map((c) => c.course_name)
                                .join(", ")}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
              <div className="modal-footer">
                <button
                  type="button"
                  className="btn btn-secondary"
                  onClick={() => setShowEditModal(false)}
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="btn btn-primary"
                  disabled={updatingRegistration}
                >
                  {updatingRegistration ? (
                    <>
                      <span className="spinner-border spinner-border-sm me-2"></span>
                      Updating...
                    </>
                  ) : (
                    "Update Registration"
                  )}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Add Note Modal */}
      {showNotesModal && (
        <div className="modal-overlay">
          <div className="modal-content">
            <div className="modal-header">
              <h5>Add Follow-up Note</h5>
              <button onClick={() => setShowNotesModal(false)}>×</button>
            </div>
            <form onSubmit={handleAddNote}>
              <div className="modal-body">
                <div className="form-group">
                  <label>
                    <strong>Registration:</strong>{" "}
                    {selectedRegistration?.student_name}
                  </label>
                </div>
                <div className="form-group">
                  <label>Follow-up Notes</label>
                  <textarea
                    className="form-control"
                    rows="4"
                    value={newNote}
                    onChange={(e) => setNewNote(e.target.value)}
                    placeholder="Enter your follow-up notes here..."
                    required
                  ></textarea>
                </div>
              </div>
              <div className="modal-footer">
                <button
                  type="button"
                  className="btn btn-secondary"
                  onClick={() => setShowNotesModal(false)}
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="btn btn-primary"
                  disabled={addingNote}
                >
                  {addingNote ? (
                    <>
                      <span className="spinner-border spinner-border-sm me-2"></span>
                      Adding...
                    </>
                  ) : (
                    "Add Note"
                  )}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* History Modal */}
      {showHistoryModal && (
        <div className="modal-overlay">
          <div className="modal-content large-modal">
            <div className="modal-header">
              <h5>Follow-up History - {selectedRegistration?.student_name}</h5>
              <button onClick={() => setShowHistoryModal(false)}>×</button>
            </div>
            <div className="modal-body">
              {loadingNotes ? (
                <div className="text-center">
                  <div className="spinner-border" role="status">
                    <span className="visually-hidden">Loading...</span>
                  </div>
                </div>
              ) : followupNotes.length === 0 ? (
                <p className="text-center">No follow-up notes found.</p>
              ) : (
                <div className="followup-timeline">
                  {followupNotes.map((note) => (
                    <div key={note.id} className="timeline-item">
                      <div className="timeline-marker"></div>
                      <div className="timeline-content">
                        <div className="timeline-header">
                          <strong>{note.user_name}</strong>
                          <span className="timeline-date">
                            {new Date(note.created_at).toLocaleString()}
                          </span>
                        </div>
                        <div className="timeline-body">{note.notes}</div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
            <div className="modal-footer">
              <button
                className="btn btn-secondary"
                onClick={() => setShowHistoryModal(false)}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
};

export default StudentTable;
